<!--//////////////////////////////////////////
//                                          //
//                 HTML                     //
//                                          //
///////////////////////////////////////////-->
<head>
    <title></title>
    <meta http-equiv="X-UA-Compatible" content="IE=9">
</head>
<body id="body" scroll="no" style="padding:0px;margin:0px;">
    <div class="container" style="height: 800px; min-width: 1200px; max-width: 1200px; border: 1px solid gray">

        <!--Gridden-->
        <div class="level-editor" style="overflow: auto; height: 100%; min-width: 950px; max-width: 950px; float: left; display: block;">
            <div class="level-editor-wrapper" style="height: 100%; max-width: 100%; border: 1px solid gray">
                <div>
                    <!--Rita dynamiskt ut gridden-->
                    <div id="TBL"></div>
                </div>
            </div>
        </div>

        <!--Valområdet-->
        <div class="select-area" style="overflow: hidden; display: block; height: 100%; min-width: 248px; max-width: 248px; float: right; border: 1px solid gray">

            <div id="optionsid" class="options" style="display: inline-block; height: 79%; width: 100%; border: 1px solid gray">

                <!--Tabs-->
                <div class="tab">
                    <button class="tablinks" onclick="openTab(event, 'Tiles')">Tiles</button>
                    <button class="tablinks" onclick="openTab(event, 'Attributes')">Attributes</button>
                    <button class="tablinks" onclick="openTab(event, 'Settings')">Settings</button>
                </div>

                <!-- Tab Tiles -->
                <div id="Tiles" class="tabcontent" style="text-align: center; min-height: 92%; max-height: 92%; overflow-y: auto; background-color: #ccc">

                    <!--Rita dynamiskt ut tiles ifrån spritesheet-->

                </div>

                <!--Tab Attribut-->
                <div id="Attributes" class="tabcontent" style="text-align: center; max-height: 92%; overflow: auto; background-color: #ccc">
                    <div style="margin: 5px;" onclick="selectAttr(0)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/zero.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px;" onclick="selectAttr(1)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/one.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px;" onclick="selectAttr(2)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/two.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px;" onclick="selectAttr(3)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/three.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px; ;" onclick="selectAttr(4)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/four.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px;" onclick="selectAttr(5)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/five.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px;" onclick="selectAttr(6)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/six.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px;" onclick="selectAttr(7)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/seven.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px" onclick="selectAttr(8)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/eight.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                    <div style="margin: 5px" onclick="selectAttr(9)">
                        <div id="tiles-box-1" style="border: 1px solid gray; clear: both; display: inline-block; max-width: 64px; min-width: 64px; height: 64px">
                            <img src="Content/Attributes/nine.bmp" style="max-width: 64px; min-width: 64px; min-height: 64px;"/>
                        </div>
                    </div>
                </div>

                <!--Tab settings-->
                <div id="Settings" class="tabcontent" style="position: relative; min-height: 92%; background-color: #ccc;">

                    <div style="padding: 10px; width: 100%; height: 150px;">
                        <p>Load New</p>
                        <button onclick="ButtonClick('load')" style="width: 100px; height: 28px; border-radius: 3px;">New</button>
                    </div>


                    <div style="padding: 10px; width: 100%; height: 150px;">
                        <p>Load Saved Map</p>
                        <button onclick="ButtonClick('loadmap')" style="width: 100px; height: 28px; border-radius: 3px;">Load</button>
                    </div>


                    <div style="padding: 10px; width: 100%; height: 150px;">
                        <p>Save and Export Map</p>
                        <button onclick="ButtonClick('export')" style="width: 100px; height: 28px; border-radius: 3px;">Save</button>
                    </div>


                    <div style="padding: 10px; width: 100%; height: 20px; position: absolute; bottom: 10px;">
                        <button onclick="ButtonClick('exit')" style="width: 100px; height: 28px; border-radius: 3px;">Exit</button>
                    </div>

                </div>

            </div>

            <!--Aktivt val-->
            <div class="selected-item" style="text-align: center; height: 20%; border: 1px solid gray">
                <div style="margin: 5px; min-height: 64px; min-width: 64px; max-width: 64px; margin: auto; padding: 50px;">
                    <img id="currently-selected-attribute-or-sprite-to-use" src="" style="max-width: 64px; min-width: 64px; min-height: 64px; border: 1px solid gray;" />
                    <div id="selected-box-1" style="clear: both; display: inline-block; min-width: 64px; max-width: 64px; min-height: 64px">
                    </div>
                </div>
            </div>
        </div>

        <!--Meddelande-->
        <div id="msg-area" style="display: block; height: 80px; width: 1200px; border: 1px solid black; background-color: whitesmoke; overflow-y: scroll; margin-top: 10px;">
            <ul id="msg-list">
                <!--<li>Message area</li>-->
            </ul>
        </div>

    </div>

    <!--//////////////////////////////////////////
    //                                          //
    //                 SCRIPT                   //
    //                                          //
    ///////////////////////////////////////////-->
    <script type="text/javascript">

        var indextile = [];
        var indexAtt = [];
        var selectedValue = 0;

        var SettingsObj = {};

        var selectedTileIs = 0;
        var selectedTinyTilePath = "";

        var tabthatisactive = { Tiles: false, Attributes: false, Settings: false };

        var LoadDefault = true;


        // Buttonclick
        function ButtonClick(name) {


            if (name === "export") {


                var krabb1IndexTile = "";
                var krabb2IndexAtt = "";

                for (var i = 0; i < indextile.length; i++) {
                    var colon = ";";
                    if (i == indextile.length - 1) {
                        colon = "";
                    }

                    krabb1IndexTile += indextile[i] + colon;
                    krabb2IndexAtt += indexAtt[i] + colon;
                }
                var dynamicObj = {
                    indextileprop: krabb1IndexTile,
                    indexAttprop: krabb2IndexAtt,
                    width: SettingsObj.LvlWidth,
                    height: SettingsObj.LvlHeight,
                    fileName: "todo: set / save name"
                };


                // Hax för att få med det "objektet" jag vill skicka med
                var resultExport = window.external.Export(dynamicObj);
                if (!resultExport) {
                    Msg("Export fail");
                } else {
                    Msg("Export success");
                }


            }
            else if (name === "load") {
                LoadDefault = true;
                INIT();
            }
            else if (name === "loadmap") {
                LoadDefault = false;
                INIT();
            }
            else {
                //skicka till backend om man inte vill krabba med massa haxiga parametrar
                var resBtnClick = window.external.ButtonClick(name);

                // Återkoppling efter knapptryck, om så behövs.
                if (resBtnClick != "") {
                    Msg(resBtnClick);
                }
            }
        }

        // (onclick attribut) Sätt aktivt val. Ett attribut har valts som ska användas att tilldela värde på önskad plats i gridden.
        function selectAttr(idselected) {
            var theElementCollection = document.getElementById("currently-selected-attribute-or-sprite-to-use");
            var mydic = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"];
            var transInt = mydic[idselected];
            var srcImg = "Content/Attributes/" + transInt + ".bmp";
            //Sätt värde aktivt val globalt
            theElementCollection.src = srcImg;
            selectedTileIs = srcImg;
            selectedTinyTilePath = "Content/Attributes/" + transInt + "tiny.bmp";
            selectedValue = idselected;
        }

        // (onclick spritetile) Sätt aktivt val. En sprite har valts som ska användas att tilldela värde på önskad plats i gridden.
        function selecttile(idselected) {
            var string = idselected;
            idselected = string.match(/\d+/g).map(Number);
            var theElementCollection = document.getElementById("currently-selected-attribute-or-sprite-to-use");
            var srcImg = "Content/Load/Tiles/img" + idselected + ".jpg";
            //Sätt värde aktivt val globalt
            theElementCollection.src = srcImg;
            selectedTileIs = srcImg;
            selectedValue = idselected;
        }

        // Inte helt säker på vad jag höll på med här..
        //document.getElementsByClassName = function (cl) {
        //    var retnode = [];
        //    var elem = this.getElementsByTagName('*');
        //    for (var i = 0; i < elem.length; i++) {
        //        if ((' ' + elem[i].className + ' ').indexOf(' ' + cl + ' ') > -1) retnode.push(elem[i]);
        //    }
        //    return retnode;
        //};

        // Tabs
        function openTab(evt, cityName) {


            if (cityName == "Tiles") {
                tabthatisactive.Tiles = true;
                tabthatisactive.Attributes = false;
                tabthatisactive.Settings = false;

                // dölj att
                var els = document.querySelectorAll('.selectatt');
                for (var i = 0; i < els.length; i++) {
                    els[i].style.display = "none";
                }

                // TODO: nolla selected tile

            } else if (cityName == "Attributes") {
                tabthatisactive.Tiles = false;
                tabthatisactive.Attributes = true;
                tabthatisactive.Settings = false;


                // visa att
                var els = document.querySelectorAll('.selectatt');
                for (var i = 0; i < els.length; i++) {
                    els[i].style.display = "block";
                }


                // TODO: nolla selected tile

            } else if (cityName == "Settings") {
                tabthatisactive.Tiles = false;
                tabthatisactive.Attributes = false;
                tabthatisactive.Settings = true;

                // Hida attribut också
                // nolla selected tile också

            } else {
                tabthatisactive.Tiles = false;
                tabthatisactive.Attributes = false;
                tabthatisactive.Settings = false;
            }


            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(cityName).style.display = "block";
            evt.currentTarget.className += " active";

        }

        // Rita dynamiskt ut sprites som ska gå att välja. Vald sprite ska sendan kunna användas för att tilldela värde i gridden.
        function DrawTiles() {

            //<div style="margin:5px" onclick="selecttile(1)">
            //    <div id="tiles-box-1" style="clear: both; display: inline-block; max-width: 64px; min-width: 64px; min-height: 64px">
            //        <img src="Content/Load/Tiles/img0.jpg" style="max-width: 64px; min-width: 64px; min-height: 64px;" />
            //    </div>
            //</div>

            //Värde från settingsfilen hur många tiles som ska ritas ut utifrån spritesheeten
            var totalnumberoftiles = SettingsObj.NumberOfTilesHeight * SettingsObj.NumberOfTilesWidth;

            // id där tiles ska ritas ut
            var theElementCollection = document.getElementById("Tiles");

            // För varje tile
            for (var i = 0; i < totalnumberoftiles; i++) {

                //Första noden
                var divtest = document.createElement("div");
                divtest.setAttribute("id", i);
                // Tilldela oncklick för att kunna göra aktivt val
                divtest.addEventListener('click', function (e) {
                    var thisClickID = e.target.id;
                    selecttile(thisClickID);
                });

                // Andra noden
                var secondnode = document.createElement("div");

                //Tredje noden  <img src="../Content/Load/Tiles/img0.jpg" />
                var img = document.createElement("img");
                var srcImg = "Content/Load/Tiles/img" + i + ".jpg";
                img.src = srcImg;
                img.className += " gridimg";
                img.className += " selecttile";
                var idtouse = "selecttileimgid" + i;
                img.setAttribute("id", idtouse);

                theElementCollection.appendChild(divtest);
                divtest.appendChild(secondnode);
                secondnode.appendChild(img);
            }

        }

        // Rita dynamiskt ut gridden
        function DrawGrid() {
            var theElementCollection = document.getElementById("TBL");
            var table = document.createElement("TABLE");
            var tblB = document.createElement("TBODY");
            table.appendChild(tblB);
            var totIdx = 0;
            // höjden
            for (var i = 0; i < SettingsObj.LvlHeight; i++) {
                var tr = document.createElement("TR");
                var isisi = "mytrid" + i;
                tr.setAttribute("id", isisi);
                tblB.appendChild(tr);
                // bredden
                for (var j = 0; j < SettingsObj.LvlWidth; j++) {
                    var td = document.createElement("TD");
                    var acctualIndex = totIdx;
                    td.setAttribute("id", acctualIndex);

                    td.addEventListener('click', function (e) {
                        var thisClickID = e.target.id;
                        dostufftoclicktarget(thisClickID);
                    });
                    tr.appendChild(td);


                    var img = document.createElement("img");
                    var idtouse = "tileimgid" + acctualIndex;
                    img.setAttribute("id", idtouse);


                    img.className += " gridimg";



                    var tileImgIndexToUse = 0;
                    var attributeImgIndexToUse = "zerotiny";
                    if (!LoadDefault) {
                        // håller på att ladda sparad map

                        // Hämta värde för tile
                        tileImgIndexToUse = indextile[totIdx];

                        // Hämta värde för attribut
                        var mydic = ["zerotiny", "onetiny", "twotiny", "threetiny", "fourtiny", "fivetiny", "sixtiny", "seventiny", "eighttiny", "ninetiny"];
                        var attValFromArray = indexAtt[totIdx];
                        attributeImgIndexToUse = mydic[attValFromArray];
                    }

                    var srcImg = "Content/Load/Tiles/img" + tileImgIndexToUse + ".jpg";
                    img.src = srcImg;


                    td.appendChild(img);



                    // Attributes image
                    var imgAtt = document.createElement("img");
                    var srcImg = "Content/Attributes/" + attributeImgIndexToUse + ".bmp";
                    imgAtt.src = srcImg;
                    imgAtt.className += " selectatt";
                    var gridselectedatt = "gridselectedatt" + totIdx;
                    imgAtt.setAttribute("id", gridselectedatt);

                    td.appendChild(imgAtt);

                    totIdx++;
                };
            };
            theElementCollection.appendChild(table);

        }


        // Om man klickar på en cell i gridden så så aktivt val till delas
        function dostufftoclicktarget(id) {

            // blev lite fuck up med vilket id som skickas in..
            var string = id;
            id = string.match(/\d+/g).map(Number);


            // Om tiles är aktiv flik
            if (tabthatisactive.Tiles == true) {


                var idtouse = "tileimgid" + id;
                var theElementCollection = document.getElementById(idtouse);


                var srcImg = selectedTileIs;
                theElementCollection.src = srcImg;

                indextile[id] = selectedValue;


            }
            //Om attribut är aktiv flik
            else if (tabthatisactive.Attributes == true) {

                // gridselectedatt + id
                var idtouse = "gridselectedatt" + id;
                var theElementCollection = document.getElementById(idtouse);
                var srcImg = selectedTinyTilePath;
                theElementCollection.src = srcImg;

                indexAtt[id] = selectedValue;
            }
            else {
                Msg("Active tab does not correspond with any ability to place a value in chosen cell");
            }

        }

        // Få värde från backend antal celler att rita ut. Sätter default allt till 0
        function InitArrays() {

            if (LoadDefault) {
                // Ladda default map
                var totalLength = SettingsObj.LvlHeight * SettingsObj.LvlWidth;
                for (var i = 0; i < totalLength; i++) {
                    indextile.push(selectedValue);
                    indexAtt.push(selectedValue);
                }
                return true;
            } else {
                // ladda sparad map
                var resultImportAttributes = window.external.Import();
                if (resultImportAttributes === "OK") {
                    //Tiles och attribut är laddade till klassen och formaterade till string. Hämta respektive sträng.
                    try {
                        //Hämta Sparade attribut
                        var resultGetSavedMapValAttributes = window.external.GetSavedMapVal("attributes");
                        if (resultGetSavedMapValAttributes != "") {

                            indexAtt =
                                resultGetSavedMapValAttributes
                                    .split(','); // sätt värde från sparad map på array indexAtt

                            //Hämta Sparade Tiles
                            var resultGetSavedMapValSprites = window.external.GetSavedMapVal("tiles");
                            if (resultGetSavedMapValSprites != "") {

                                indextile =
                                    resultGetSavedMapValSprites
                                        .split(','); // sätt värde från sparad map på array indextile

                                Msg("Import success");

                            } else {
                                Msg("resultGetSavedMapValSprites Empty");
                                return false;
                            }
                        } else {
                            Msg("resultGetSavedMapValAttributes Empty");
                            return false;
                        }




                    } catch (e) {
                        Msg("Catch - GetSavedMapVal: " + e);
                        return false;
                    }

                } else {
                    Msg(resultImportAttributes);
                    return false;
                }


            }

        }


        //Skriva saker i vyn
        function Msg(msg) {
            //Hämta tid
            var today = new Date();
            var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
            var newItem = document.createElement("LI");       // skapa en <li> node
            var textnode = document.createTextNode(time + " " + msg);  // skapa en text node
            newItem.appendChild(textnode);                    // appenda text till <li>
            var list = document.getElementById("msg-list");    // hämta <ul> elementet och inserta nya noden
            list.insertBefore(newItem, list.childNodes[0]);  // inserta <li> innan första child i <ul>
        }

        try {
            function INIT() {
                var debug = false;
                if (!debug) {


                    var obj = window.external.InitJs("parameter");


                    if (obj != null) {

                        // LOOPA alla tiles

                        var res = obj.split("/");
                        for (var i = 0; i < res.length; i++) {

                            var resVal = res[i];
                            var splitResVal = resVal.split(":");

                            switch (splitResVal[0]) {
                                case "LvlHeight":
                                    SettingsObj.LvlHeight = splitResVal[1];

                                    break;
                                case "LvlWidth":
                                    SettingsObj.LvlWidth = splitResVal[1];

                                    break;
                                case "NumberOfTilesWidth":
                                    SettingsObj.NumberOfTilesWidth = splitResVal[1];

                                    break;
                                case "NumberOfTilesHeight":
                                    SettingsObj.NumberOfTilesHeight = splitResVal[1];

                                    break;
                                case "TileWidthPX":
                                    SettingsObj.TileWidthPX = splitResVal[1];

                                    break;
                                case "TileHeightPX":
                                    SettingsObj.TileHeightPX = splitResVal[1];

                                    break;
                                default:

                            }


                        }

                        InitArrays();

                        DrawTiles();

                        DrawGrid();


                    } else {
                        Msg("null");
                    }
                } else {

                    //mock settings obj
                    SettingsObj.LvlHeight = 20;

                    SettingsObj.LvlWidth = 20;

                    SettingsObj.NumberOfTilesWidth = 5;

                    SettingsObj.NumberOfTilesHeight = 5;

                    SettingsObj.TileWidthPX = 16;

                    SettingsObj.TileHeightPX = 16;
                    //
                    DrawGrid();
                    DrawTiles();

                }
            }
            setTimeout(function () {
                // INIT(); // Måste laddas från knapp now a days
            }, 3000);


        } catch (e) {
            Msg("init catch - " + e);
        }



    </script>


    <!--//////////////////////////////////////////
    //                                          //
    //                 STYLE                    //
    //                                          //
    ///////////////////////////////////////////-->
    <style>

        .selectatt {
            position: absolute;
            z-index: 50;
            top: 2px;
            left: 2px;
            display: block;
        }

            .selectatt.show {
                display: block;
            }

            .selectatt.dontshow {
                display: none;
            }

        /*img*/
        img.gridimg {
            max-width: 64px;
            min-width: 64px;
            min-height: 64px;
        }

            img.gridimg.selecttile {
                padding: 5px;
                border: 1px solid gray;
            }

        /*grid*/
        table td {
            position: relative;
        }

        table {
            margin: auto;
        }

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

            /* Style the buttons that are used to open the tab content */
            .tab button {
                background-color: inherit;
                float: left;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 10px 10px;
                transition: 0.3s;
            }

                /* Change background color of buttons on hover */
                .tab button:hover {
                    background-color: #ddd;
                }

                /* Create an active/current tablink class */
                .tab button.active {
                    background-color: #ccc;
                }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            clear: both;
        }
    </style>

</body>